<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Horario - ISTT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            touch-action: pan-y;
        }

        .header {
            background: linear-gradient(135deg, #0097A7 0%, #00838F 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 200;
            flex-wrap: wrap;
        }

        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .menu-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 200px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            padding: 4px;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-title {
            flex: 1;
            min-width: 0;
        }

        .header-title h1 {
            font-size: 18px;
            font-weight: bold;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-title p {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-header {
            background: rgba(255,255,255,0.15);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.25);
        }

        .btn-enviar {
            background: #4CAF50;
        }

        .btn-enviar:hover {
            background: #388E3C;
        }

        .icon {
            width: 16px;
            height: 16px;
        }

        .sidebar {
            position: fixed;
            left: -100%;
            top: 0;
            width: 85%;
            max-width: 300px;
            height: 100vh;
            background: #FFFFFF;
            transition: left 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%);
            padding: 24px 20px;
        }

        .sidebar-header h2 {
            color: #FFFFFF;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .sidebar-menu {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }

        .menu-item {
            padding: 14px 20px;
            color: #263238;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            margin: 4px 12px;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
        }

        .menu-item:hover {
            background: #F0F4F8;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .user-section {
            border-top: 1px solid #E1E8ED;
            background: #FAFBFC;
        }

        .user-info {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .user-info:hover {
            background: #F0F4F8;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            border: 3px solid #E1F5FE;
            box-shadow: 0 2px 8px rgba(0,188,212,0.25);
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            color: #263238;
            font-size: 14px;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-role {
            color: #78909C;
            font-size: 12px;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-arrow {
            color: #90A4AE;
            font-size: 12px;
            transition: transform 0.3s;
        }

        .user-arrow.rotated {
            transform: rotate(180deg);
        }

        .user-dropdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #F5F8FA;
        }

        .user-dropdown.active {
            max-height: 200px;
        }

        .dropdown-item {
            padding: 14px 20px;
            color: #263238;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            margin: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
        }

        .dropdown-item:hover {
            background: #E3F2FD;
        }

        .dropdown-item.logout {
            color: #FFFFFF;
            background: #EF5350;
        }

        .dropdown-item.logout:hover {
            background: #E53935;
        }

        .logout-icon {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 999;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .container {
            padding: 16px;
            max-width: 100%;
            overflow-x: auto;
        }

        .activities-floating-bar {
            position: fixed;
            top: 78px;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-bottom: 2px solid #0097A7;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 150;
            padding: 8px 0 12px 0;
        }

        .activities-floating-content {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }

        .activities-title {
            font-size: 13px;
            font-weight: 700;
            color: #0097A7;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .activities-title .full-text {
            display: inline;
        }

        .activities-title .short-text {
            display: none;
        }

        @media screen and (max-width: 768px) {
            .activities-title .full-text {
                display: none;
            }

            .activities-title .short-text {
                display: inline;
            }
        }

        .activities-scroll-wrapper {
            position: relative;
            width: 100%;
        }

        .activities-scroll-wrapper::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 6px;
            width: 40px;
            background: linear-gradient(to left, #ffffff, transparent);
            pointer-events: none;
            z-index: 1;
        }

        .activities-scroll-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 4px 6px 4px;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #0097A7 #e0e0e0;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-x;
        }

        .activities-scroll-container::-webkit-scrollbar {
            height: 5px;
        }

        .activities-scroll-container::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 3px;
        }

        .activities-scroll-container::-webkit-scrollbar-thumb {
            background: #0097A7;
            border-radius: 3px;
        }

        .activities-nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 8px;
        }

        .btn-nav-activities {
            background: #0097A7;
            color: white;
            border: none;
            padding: 0;
            width: 38px;
            height: 38px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .btn-nav-activities:hover {
            background: #00838F;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn-nav-activities:active {
            transform: translateY(0);
        }

        .btn-nav-activities svg {
            width: 22px;
            height: 22px;
        }

        .activity-item {
            background: linear-gradient(135deg, #ffffff 0%, #f0f4f8 100%);
            border: 2px solid #0097A7;
            color: #333;
            padding: 12px 14px;
            border-radius: 8px;
            cursor: grab;
            font-size: 11px;
            transition: all 0.3s;
            user-select: none;
            line-height: 1.4;
            min-width: 180px;
            max-width: 200px;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
            touch-action: pan-y;
            will-change: transform;
        }

        .activity-item:active {
            cursor: grabbing;
            transform: scale(0.98);
        }

        .activity-item.dragging {
            opacity: 0.3;
            transform: scale(0.95);
        }

        .activity-item.blocked {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #EF5350;
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            transform: none !important;
        }

        .activity-code {
            font-weight: 700;
            font-size: 14px;
            display: block;
            margin-bottom: 4px;
            color: #0097A7 !important;
        }

        .activity-desc {
            font-size: 10px;
            color: #546E7A !important;
            display: block;
            line-height: 1.3;
            margin-bottom: 6px;
        }

        .activity-limit {
            font-size: 11px;
            font-weight: 600;
            color: #00695C;
            background: #E0F2F1;
            padding: 4px 10px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 3px;
        }

        .activity-limit.warning {
            color: #E65100;
            background: #FFF3E0;
        }

        .activity-limit.exceeded {
            color: #C62828;
            background: #FFEBEE;
        }

        .content-with-floating-bar {
            margin-top: 200px;
        }

        .hours-indicator {
            background: #E3F2FD;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .hours-indicator-title {
            font-size: 13px;
            font-weight: 700;
            color: #1976D2;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 8px;
        }

        .day-hours-item {
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #BBDEFB;
        }

        .day-hours-item.exceeded {
            background: #FFEBEE;
            border-color: #EF5350;
            color: #C62828;
            font-weight: 600;
        }

        .day-hours-item.warning {
            background: #FFF3E0;
            border-color: #FF9800;
            color: #E65100;
        }

        .day-hours-item.ok {
            background: #E8F5E9;
            border-color: #4CAF50;
            color: #2E7D32;
        }

        .day-name {
            font-weight: 600;
        }

        .hours-count {
            font-weight: 700;
        }

        .info-panel {
            background: #e3f2fd;
            padding: 10px 14px;
            border-radius: 4px;
            margin-bottom: 16px;
            border-left: 3px solid #0097A7;
            font-size: 12px;
            color: #01579b;
            line-height: 1.6;
        }

        .info-panel .mobile-text {
            display: none;
        }

        @media screen and (max-width: 768px) {
            .info-panel .desktop-text {
                display: none;
            }

            .info-panel .mobile-text {
                display: inline;
            }
        }

        .observaciones-panel {
            background: #FFF3E0;
            border: 2px solid #FF9800;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .observaciones-title {
            font-size: 16px;
            font-weight: 600;
            color: #E65100;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .observacion-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #FF9800;
        }

        .observacion-header {
            font-size: 13px;
            font-weight: 600;
            color: #E65100;
            margin-bottom: 6px;
        }

        .observacion-texto {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .observacion-especificas {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #FFB74D;
        }

        .horario-container {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .institution-name {
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            color: #000;
            margin-bottom: 4px;
        }

        .teacher-name {
            font-size: 15px;
            font-weight: 700;
            text-align: center;
            color: #000;
            margin-bottom: 16px;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            min-width: 800px;
        }

        .schedule-table thead th {
            border: 2px solid #000;
            padding: 8px 4px;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            color: #000 !important;
            vertical-align: middle;
            height: 65px;
        }
        
        .schedule-table thead th * {
            color: #000 !important;
        }

        .schedule-table thead th:first-child {
            background: white;
            border: 1px solid #ccc;
            width: 7%;
            min-width: 50px;
        }

        .schedule-table thead th.header-green {
            background: #00695C;
        }

        .schedule-table thead th.header-yellow {
            background: #FFFF00;
        }

        .period-num {
            display: block;
            font-size: 15px;
            font-weight: 700;
            color: #000 !important;
        }

        .period-time {
            display: block;
            font-size: 9px;
            font-weight: normal;
            margin-top: 4px;
            color: #000 !important;
        }

        .schedule-table tbody th {
            border: 2px solid #000;
            padding: 12px 6px;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            width: 7%;
            min-width: 50px;
            color: #000 !important;
            vertical-align: middle;
        }
        
        .schedule-table tbody th * {
            color: #000 !important;
        }

        .schedule-table tbody th.day-green {
            background: #00695C;
        }

        .schedule-table tbody th.day-yellow {
            background: #FFFF00;
        }

        .schedule-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            background: white;
            font-size: 12px;
            line-height: 1.3;
            height: 75px;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            color: #000 !important;
        }
        
        .schedule-table td * {
            color: #000 !important;
        }

        .schedule-table td.has-class::after {
            content: '';
            position: absolute;
            top: 3px;
            right: 3px;
            width: 10px;
            height: 10px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'%3E%3C/rect%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'%3E%3C/path%3E%3C/svg%3E");
            opacity: 0.3;
        }

        .schedule-table td.drop-zone {
            background: #e8f5e9 !important;
            border: 2px dashed #4caf50 !important;
        }

        .schedule-table td.drop-zone-blocked {
            background: #ffebee !important;
            border: 2px solid #ef5350 !important;
            cursor: not-allowed !important;
            opacity: 0.5;
        }

        .schedule-table td.taes-allowed::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 10px;
            height: 10px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff9800' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpolyline points='12 6 12 12 16 14'%3E%3C/polyline%3E%3C/svg%3E");
            opacity: 0.4;
        }

        .schedule-table td.has-activity {
            cursor: move;
        }

        .schedule-table td.observada {
            background: #FFEBEE !important;
            border: 2px solid #EF5350 !important;
        }

        .schedule-table td.celda-resaltada {
            background: #FFF9C4 !important;
            border: 3px solid #FF9800 !important;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.6);
            animation: pulso 0.5s ease-in-out 3;
        }

        @keyframes pulso {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .lesson-class {
            font-weight: normal;
            color: #000 !important;
            display: block;
            font-size: 10px;
            margin-bottom: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .lesson-subject {
            color: #000 !important;
            font-size: 13px;
            font-weight: 700;
            display: block;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .activity-description {
            font-weight: normal;
            color: #000 !important;
            display: block;
            font-size: 9px;
            margin-top: 3px;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .activity-hours {
            font-weight: 600;
            color: #0097A7 !important;
            display: block;
            font-size: 11px;
            margin-top: 4px;
            background: #E0F7FA;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
        }

        .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ef5350;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .remove-btn:hover {
            background: #d32f2f;
        }

        .schedule-table td.has-activity:hover .remove-btn {
            opacity: 1;
        }

        .color-1 { background-color: #fff9cc; }
        .color-2 { background-color: #e6f4ea; }
        .color-3 { background-color: #ffe6f0; }
        .color-4 { background-color: #e6f2ff; }
        .color-5 { background-color: #fff0e6; }
        .color-6 { background-color: #f0e6ff; }
        .color-7 { background-color: #e6fff9; }
        .color-8 { background-color: #ffffe6; }
        .color-complementaria { background-color: #ffe0b2; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #263238;
            margin-bottom: 10px;
        }

        .modal-message {
            font-size: 14px;
            color: #78909C;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-modal {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-confirmar {
            background: #4CAF50;
            color: white;
        }

        .btn-confirmar:hover {
            background: #388E3C;
        }

        .btn-cancelar {
            background: #E0E0E0;
            color: #263238;
        }

        .btn-cancelar:hover {
            background: #BDBDBD;
        }

        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid #0097A7;
        }

        .toast.success {
            border-left-color: #4CAF50;
        }

        .toast.error {
            border-left-color: #EF5350;
        }

        .toast.warning {
            border-left-color: #FF9800;
        }

        .toast.info {
            border-left-color: #2196F3;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease;
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .toast-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: #333;
        }

        /* MEDIA QUERIES PARA RESPONSIVIDAD */
        @media screen and (max-width: 768px) {
            .header {
                padding: 10px;
            }

            .header-title h1 {
                font-size: 14px;
            }

            .header-title p {
                font-size: 10px;
            }

            .logo {
                width: 40px;
                height: 40px;
            }

            .btn-header {
                padding: 6px 12px;
                font-size: 12px;
            }

            .icon {
                width: 14px;
                height: 14px;
            }

            .container {
                padding: 12px;
            }

            .activities-floating-bar {
                top: 100px;
            }

            .activities-floating-content {
                padding: 0 12px;
            }

            .activities-title {
                font-size: 10px;
                text-transform: none;
                letter-spacing: 0.3px;
            }

            .activities-title svg {
                display: none;
            }

            .activity-item {
                min-width: 160px;
                max-width: 180px;
                font-size: 10px;
                padding: 10px 12px;
            }

            .activity-code {
                font-size: 13px;
            }

            .activity-desc {
                font-size: 9px;
            }

            .activity-limit {
                font-size: 10px;
            }

            .content-with-floating-bar {
                margin-top: 180px;
            }

            .btn-nav-activities {
                width: 35px;
                height: 35px;
            }

            .btn-nav-activities svg {
                width: 20px;
                height: 20px;
            }

            .hours-indicator {
                padding: 10px 12px;
            }

            .hours-indicator-title {
                font-size: 11px;
            }

            .day-hours-item {
                font-size: 10px;
                padding: 4px 8px;
            }

            .info-panel {
                font-size: 11px;
                padding: 8px 12px;
            }

            .desktop-text {
                display: none;
            }

            .mobile-text {
                display: inline;
            }

            .observaciones-panel {
                padding: 12px;
            }

            .observaciones-title {
                font-size: 14px;
            }

            .observacion-item {
                padding: 10px;
            }

            .observacion-header {
                font-size: 12px;
            }

            .observacion-texto {
                font-size: 12px;
            }

            .observacion-especificas {
                font-size: 11px;
            }

            .horario-container {
                padding: 12px;
            }

            .institution-name {
                font-size: 12px;
            }

            .teacher-name {
                font-size: 13px;
            }

            .toast-container {
                top: 70px;
                right: 10px;
                max-width: 300px;
            }

            .toast {
                padding: 10px 12px;
            }

            .toast-message {
                font-size: 12px;
            }

            .modal-content {
                padding: 20px;
            }

            .modal-icon {
                width: 50px;
                height: 50px;
            }

            .modal-title {
                font-size: 18px;
            }

            .modal-message {
                font-size: 13px;
            }

            .modal-actions {
                justify-content: stretch;
            }

            .btn-modal {
                flex: 1;
            }

            .sidebar {
                width: 90%;
            }
        }

        @media screen and (max-width: 480px) {
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .btn-header {
                flex: 1;
                justify-content: center;
            }

            .header-title h1 {
                font-size: 12px;
            }

            .activities-title {
                font-size: 10px;
            }

            .activity-item {
                min-width: 150px;
                max-width: 170px;
                padding: 10px 12px;
            }

            .hours-indicator-title {
                font-size: 10px;
            }

            .day-hours-item {
                font-size: 9px;
            }

            .toast-container {
                right: 5px;
                left: 5px;
                max-width: calc(100% - 10px);
            }

            .modal-actions {
                flex-direction: column;
            }

            .btn-modal {
                width: 100%;
            }

            .sidebar {
                width: 95%;
            }
        }

        /* Elemento fantasma para drag visual en m√≥viles */
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            opacity: 0.9;
            will-change: transform;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transform-origin: center;
        }
    </style>
</head>
<body data-horario-id="{{ horario_id }}" data-actividades='{{ actividades_disponibles|tojson }}' data-limites='{{ limites_actividades|tojson }}' data-horas-dia='{{ horas_por_dia|tojson }}'>
    <div class="toast-container" id="toastContainer"></div>
    <div class="header">
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
        <div class="logo-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='icono.png') }}" alt="ISTT Logo">
            </div>
            <div class="header-title">
                <h1>INSTITUTO SUPERIOR TECNOL√ìGICO TENA</h1>
                <p>Visualizaci√≥n de Horarios</p>
            </div>
        </div>
        <div class="header-actions">
            {% if estado in ['borrador', 'rechazado_coordinador', 'rechazado_rectorado'] %}
            <button class="btn-header btn-enviar" onclick="enviarRevision()">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                Enviar a Revisi√≥n
            </button>
            {% endif %}
            <button class="btn-header" onclick="window.location.href='/dashboard'">‚Üê Volver</button>
        </div>
    </div>

    <div class="activities-floating-bar">
        <div class="activities-floating-content">
            <div class="activities-title">
                <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                <span class="full-text">Actividades Complementarias (Desliza ‚Üí para ver m√°s, mant√©n y arrastra ‚Üì al horario)</span>
                <span class="short-text">Desliza ‚Üí | Mant√©n y arrastra ‚Üì</span>
            </div>
            <div class="activities-scroll-wrapper">
                <div class="activities-scroll-container" id="activitiesGrid"></div>
            </div>
            <div class="activities-nav-buttons">
                <button class="btn-nav-activities" id="btnScrollLeft" aria-label="Anterior">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button class="btn-nav-activities" id="btnScrollRight" aria-label="Siguiente">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Men√∫ Principal</h2>
        </div>
        
        <div class="sidebar-menu">
            <a href="/bandeja" class="menu-item">
                <svg class="menu-icon" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
                <span>Bandeja de Horarios</span>
            </a>
            <a href="/dashboard" class="menu-item">
                <svg class="menu-icon" viewBox="0 0 24 24">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>Cargar Horario</span>
            </a>
        </div>

        <div class="user-section">
            <div class="user-info" id="userInfo">
                <div class="user-avatar">{{ nombre[0] if nombre else 'U' }}</div>
                <div class="user-details">
                    <div class="user-name">{{ nombre }}</div>
                    <div class="user-role">{{ cargo }}</div>
                </div>
                <span class="user-arrow" id="userArrow">‚ñº</span>
            </div>
            <div class="user-dropdown" id="userDropdown">
                <a href="/cambiar_password" class="dropdown-item">
                    <svg class="logout-icon" viewBox="0 0 24 24">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span>Cambiar Contrase√±a</span>
                </a>
                <a href="/logout" class="dropdown-item logout">
                    <svg class="logout-icon" viewBox="0 0 24 24">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Cerrar sesi√≥n</span>
                </a>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="container content-with-floating-bar">
        {% if observaciones %}
        <div class="observaciones-panel">
            <div class="observaciones-title">
                <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Observaciones del Revisor
            </div>
            {% for obs in observaciones %}
            <div class="observacion-item">
                <div class="observacion-header">
                    {{ obs.revisor_nombre }} - {{ obs.fecha[:16] }}
                </div>
                {% if obs.observacion_general %}
                <div class="observacion-texto">
                    <strong>Observaci√≥n General:</strong> {{ obs.observacion_general }}
                </div>
                {% endif %}
                {% if obs.especificas %}
                <div class="observacion-especificas">
                    <strong>Observaciones Espec√≠ficas:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        {% for esp in obs.especificas %}
                        <li style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" 
                            onmouseover="this.style.background='#FFE0B2'" 
                            onmouseout="this.style.background='transparent'"
                            onclick="resaltarCelda('{{ esp.dia_id }}', '{{ esp.periodo_id }}')">
                            {{ esp.dia_nombre }}, Per√≠odo {{ esp.periodo_id }}: {{ esp.comentario }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="hours-indicator" id="hoursIndicator">
            <div class="hours-indicator-title">
                <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                L√≠mite de Horas por D√≠a:
            </div>
            <div id="dayHoursContainer"></div>
        </div>

        <div class="info-panel">
            <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <strong>Instrucciones:</strong> 
            <span class="desktop-text">Toca y arrastra las actividades desde la barra superior a las casillas del horario.</span>
            <span class="mobile-text">Desliza horizontalmente ‚Üí para ver m√°s actividades. Mant√©n presionado y arrastra hacia abajo ‚Üì para colocar actividades en el horario.</span>
            Las actividades adyacentes del mismo tipo se fusionar√°n autom√°ticamente. <strong>L√≠mite:</strong> M√°ximo 8 horas por d√≠a (clases + actividades). <strong>Importante:</strong> T/AES solo puede colocarse en per√≠odos 6, 7, 9 y 10 (üïê), pero otras actividades pueden ir en cualquier per√≠odo.
        </div>

        {% for profesor in horario.profesores %}
        <div class="horario-container">
            <div class="institution-name">{{ horario.institucion }}</div>
            <div class="teacher-name">Profesor {{ profesor.nombre }}</div>

            <div class="table-wrapper">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th></th>
                            {% for periodo in horario.periodos %}
                            <th class="{{ 'header-green' if loop.index0 % 2 == 0 else 'header-yellow' }}">
                                <span class="period-num">{{ periodo.name }}</span>
                                {% if periodo.starttime and periodo.endtime %}
                                <span class="period-time">{{ periodo.starttime }} - {{ periodo.endtime }}</span>
                                {% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for fila in profesor.matriz_procesada %}
                        <tr>
                            <th class="{{ 'day-green' if loop.index0 % 2 == 0 else 'day-yellow' }}">
                                {{ fila.dia.short }}
                            </th>
                            {% for celda in fila.celdas %}
                                {% if celda.tipo == 'clase' %}
                                    <td class="has-class {{ celda.color }}" 
                                        colspan="{{ celda.colspan }}"
                                        data-dia="{{ celda.dia_id }}" 
                                        data-periodo="{{ celda.periodo_id }}">
                                        <span class="lesson-subject">{{ celda.materia }}</span>
                                        {% if celda.clase %}
                                        <span class="lesson-class">{{ celda.clase }}</span>
                                        {% endif %}
                                    </td>
                                {% elif celda.tipo == 'actividad' %}
                                    <td class="has-activity color-complementaria" 
                                        colspan="{{ celda.colspan }}"
                                        data-dia="{{ celda.dia_id }}" 
                                        data-periodo="{{ celda.periodo_id }}"
                                        data-actividad="{{ celda.codigo }}"
                                        data-activity-code="{{ celda.codigo }}"
                                        data-horas="{{ celda.colspan }}"
                                        draggable="true">
                                        <button class="remove-btn" onclick="removeActivity(this)">√ó</button>
                                        <span class="lesson-subject">{{ celda.codigo }}</span>
                                        <span class="activity-description"></span>
                                        {% if celda.colspan > 1 %}
                                        <span class="activity-hours">{{ celda.colspan }} horas</span>
                                        {% endif %}
                                    </td>
                                {% else %}
                                    <td class="drop-target {{ 'taes-allowed' if celda.permite_taes else '' }}" 
                                        data-dia="{{ celda.dia_id }}" 
                                        data-periodo="{{ celda.periodo_id }}"
                                        data-permite-taes="{{ 'true' if celda.permite_taes else 'false' }}">
                                    </td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <svg class="modal-icon" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <h3 class="modal-title">¬øEnviar horario a revisi√≥n?</h3>
            <p class="modal-message" id="modalMessage">El horario ser√° enviado al coordinador para revisi√≥n.</p>
            <div class="modal-actions">
                <button class="btn-modal btn-confirmar" onclick="confirmarEnvio()">Confirmar</button>
                <button class="btn-modal btn-cancelar" onclick="cerrarModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        var body = document.body;
        var horarioId = body.getAttribute('data-horario-id');
        var actividadesDisponibles = JSON.parse(body.getAttribute('data-actividades') || '{}');
        var limitesActividades = JSON.parse(body.getAttribute('data-limites') || '{}');
        var horasPorDiaInicial = JSON.parse(body.getAttribute('data-horas-dia') || '{}');
        
        var draggedElement = null;
        var draggedTipo = null;
        var draggedSource = null;
        var draggedDesc = null;
        var usoPorActividad = {};
        var PERIODOS_TAES = ['6', '7', '9', '10'];
        var HORAS_MAXIMAS_POR_DIA = 8;
        var horasPorDia = {};

        // Variables para touch events
        var touchStartX = 0;
        var touchStartY = 0;
        var touchElement = null;
        var ghostElement = null;
        var isTouchDragging = false;
        var touchStartTime = 0;
        var touchMoved = false;
        var dragTimeout = null;
        var lastTouchX = 0;
        var lastTouchY = 0;
        var animationFrameId = null;

        function showToast(message, type, duration) {
            if (!type) type = 'info';
            // Duraci√≥n m√°s larga para errores y warnings
            if (!duration) {
                if (type === 'error' || type === 'warning') {
                    duration = 5000; // 5 segundos para errores
                } else {
                    duration = 4000; // 4 segundos para otros
                }
            }
            
            console.log('TOAST:', type, '-', message);
            
            var container = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            
            var icons = {
                success: '<svg viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
                error: '<svg viewBox="0 0 24 24" fill="none" stroke="#EF5350" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
                warning: '<svg viewBox="0 0 24 24" fill="none" stroke="#FF9800" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
                info: '<svg viewBox="0 0 24 24" fill="none" stroke="#2196F3" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
            };
            
            toast.innerHTML = '<div class="toast-icon">' + icons[type] + '</div><div class="toast-message">' + message + '</div><button class="toast-close" onclick="closeToast(this)">√ó</button>';
            
            container.appendChild(toast);
            
            setTimeout(function() {
                closeToast(toast.querySelector('.toast-close'));
            }, duration);
        }

        function closeToast(button) {
            var toast = button.parentElement;
            toast.classList.add('hiding');
            setTimeout(function() {
                toast.remove();
            }, 300);
        }

        function inicializarHorasPorDia() {
            horasPorDia = {};
            calcularHorasPorDia();
        }

        function actualizarIndicadorHoras() {
            var container = document.getElementById('dayHoursContainer');
            container.innerHTML = '';
            
            var filas = document.querySelectorAll('.schedule-table tbody tr');
            
            filas.forEach(function(fila, index) {
                var thDia = fila.querySelector('th');
                if (!thDia) return;
                
                var diaNombre = thDia.textContent.trim();
                var diaId = String(index + 1);
                
                var horas = horasPorDia[diaId] || 0;
                var disponibles = HORAS_MAXIMAS_POR_DIA - horas;
                
                var item = document.createElement('div');
                item.className = 'day-hours-item';
                item.setAttribute('data-dia-id', diaId);
                
                if (horas > HORAS_MAXIMAS_POR_DIA) {
                    item.classList.add('exceeded');
                } else if (horas === HORAS_MAXIMAS_POR_DIA) {
                    item.classList.add('warning');
                } else {
                    item.classList.add('ok');
                }
                
                item.innerHTML = '<span class="day-name">' + diaNombre + ':</span><span class="hours-count">' + horas + '/8h</span>' + (disponibles >= 0 ? '(' + disponibles + 'h libres)' : '(¬°' + Math.abs(disponibles) + 'h excedidas!)');
                
                container.appendChild(item);
            });
        }

        function calcularHorasPorDia() {
            horasPorDia = {};
            
            document.querySelectorAll('.schedule-table tbody tr').forEach(function(fila, index) {
                var diaId = String(index + 1);
                var totalHoras = 0;
                
                fila.querySelectorAll('td.has-class').forEach(function(celda) {
                    var colspan = parseInt(celda.getAttribute('colspan') || '1');
                    totalHoras += colspan;
                });
                
                fila.querySelectorAll('td.has-activity').forEach(function(celda) {
                    var colspan = parseInt(celda.getAttribute('colspan') || '1');
                    totalHoras += colspan;
                });
                
                horasPorDia[diaId] = totalHoras;
            });
            
            actualizarIndicadorHoras();
        }

        function obtenerDiaIdDesdeFila(celda) {
            var fila = celda.closest('tr');
            var tbody = fila.parentElement;
            var filas = Array.from(tbody.querySelectorAll('tr'));
            var filaIndex = filas.indexOf(fila);
            return String(filaIndex + 1);
        }

        function esPeriodoValidoParaTAES(periodoId) {
            return PERIODOS_TAES.indexOf(periodoId.toString()) !== -1;
        }

        // SOPORTE T√ÅCTIL OPTIMIZADO
        function handleTouchStart(e) {
            var target = e.currentTarget;
            var codigo = target.getAttribute('data-code');
            var limite = limitesActividades[codigo] || 0;
            var uso = usoPorActividad[codigo] || 0;
            
            if (target.classList.contains('blocked') || uso >= limite) {
                return;
            }
            
            var touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            lastTouchX = touch.clientX;
            lastTouchY = touch.clientY;
            touchElement = target;
            isTouchDragging = false;
            touchMoved = false;
            touchStartTime = Date.now();
            
            draggedElement = target;
            draggedTipo = target.getAttribute('data-tipo');
            draggedSource = 'barra';
            draggedDesc = target.getAttribute('data-desc');
            
            // Delay de 200ms antes de activar drag para permitir scroll
            dragTimeout = setTimeout(function() {
                if (touchElement && !touchMoved) {
                    target.classList.add('dragging');
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                }
            }, 200);
        }

        function handleTouchMove(e) {
            if (!touchElement) return;
            
            var touch = e.touches[0];
            var deltaX = Math.abs(touch.clientX - touchStartX);
            var deltaY = Math.abs(touch.clientY - touchStartY);
            var moveX = touch.clientX - touchStartX;
            
            // Si se mueve m√°s horizontal que vertical y a√∫n no empez√≥ el drag, permitir scroll
            if (!isTouchDragging && deltaX > deltaY && deltaX > 15) {
                clearTimeout(dragTimeout);
                touchElement.classList.remove('dragging');
                touchElement = null;
                draggedElement = null;
                return;
            }
            
            // Si se mueve verticalmente o pas√≥ el tiempo, activar drag
            if (!isTouchDragging && (deltaY > 15 || (deltaX < 10 && Date.now() - touchStartTime > 200))) {
                e.preventDefault();
                touchMoved = true;
                isTouchDragging = true;
                clearTimeout(dragTimeout);
                touchElement.classList.add('dragging');
                
                if (navigator.vibrate) {
                    navigator.vibrate(40);
                }
                
                // Crear ghost element optimizado
                ghostElement = touchElement.cloneNode(true);
                ghostElement.classList.add('drag-ghost');
                ghostElement.style.width = touchElement.offsetWidth + 'px';
                ghostElement.style.position = 'fixed';
                ghostElement.style.pointerEvents = 'none';
                ghostElement.style.zIndex = '10000';
                ghostElement.style.willChange = 'transform';
                document.body.appendChild(ghostElement);
            }
            
            if (isTouchDragging) {
                e.preventDefault();
                
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
                
                // Usar requestAnimationFrame para movimiento fluido
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                
                animationFrameId = requestAnimationFrame(function() {
                    if (ghostElement) {
                        var offsetX = -ghostElement.offsetWidth / 2;
                        var offsetY = -ghostElement.offsetHeight / 2;
                        ghostElement.style.left = (lastTouchX + offsetX) + 'px';
                        ghostElement.style.top = (lastTouchY + offsetY) + 'px';
                    }
                });
                
                var elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                
                document.querySelectorAll('.drop-zone, .drop-zone-blocked').forEach(function(el) {
                    el.classList.remove('drop-zone', 'drop-zone-blocked');
                });
                
                if (elementBelow && elementBelow.classList.contains('drop-target')) {
                    var codigo = draggedElement.getAttribute('data-code');
                    var periodoId = elementBelow.getAttribute('data-periodo');
                    
                    // Solo validar si tenemos c√≥digo v√°lido
                    if (codigo) {
                        // √öNICA VALIDACI√ìN: Bloquear si T/AES en per√≠odo no v√°lido
                        if (codigo === 'T/AES' && !esPeriodoValidoParaTAES(periodoId)) {
                            elementBelow.classList.add('drop-zone-blocked');
                        }
                        else {
                            elementBelow.classList.add('drop-zone');
                        }
                        
                        // ELIMINADO: Ya no bloqueamos otras actividades en per√≠odos T/AES
                    }
                }
            }
        }

        function handleTouchEnd(e) {
            if (!touchElement) {
                console.log('Touch end - No touchElement');
                return;
            }
            
            clearTimeout(dragTimeout);
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            touchElement.classList.remove('dragging');
            
            if (isTouchDragging && ghostElement) {
                e.preventDefault();
                var touch = e.changedTouches[0];
                var elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                
                console.log('=== TOUCH END ===');
                console.log('Element below:', elementBelow);
                console.log('Es drop-target?', elementBelow ? elementBelow.classList.contains('drop-target') : 'no element');
                
                if (elementBelow && elementBelow.classList.contains('drop-target')) {
                    var codigo = draggedElement.getAttribute('data-code');
                    console.log('Intentando colocar:', codigo);
                    
                    if (navigator.vibrate) {
                        navigator.vibrate([20, 10, 20]);
                    }
                    
                    handleDropOnTarget(elementBelow, codigo, draggedTipo, draggedDesc, 'barra');
                } else {
                    console.log('No se solt√≥ en una zona v√°lida');
                    showToast('Suelta en una casilla vac√≠a del horario', 'info');
                }
                
                ghostElement.remove();
                ghostElement = null;
            }
            
            document.querySelectorAll('.drop-zone, .drop-zone-blocked').forEach(function(el) {
                el.classList.remove('drop-zone', 'drop-zone-blocked');
            });
            
            touchElement = null;
            draggedElement = null;
            draggedTipo = null;
            draggedSource = null;
            draggedDesc = null;
            isTouchDragging = false;
            touchMoved = false;
        }

        function inicializarActividades() {
            var grid = document.getElementById('activitiesGrid');
            
            contarActividadesEnHorario();
            
            for (var codigo in actividadesDisponibles) {
                var descripcion = actividadesDisponibles[codigo];
                var limite = limitesActividades[codigo] || 0;
                var uso = usoPorActividad[codigo] || 0;
                
                var item = document.createElement('div');
                item.className = 'activity-item';
                item.setAttribute('draggable', limite > 0 ? 'true' : 'false');
                item.setAttribute('data-code', codigo);
                item.setAttribute('data-tipo', 'normal');
                item.setAttribute('data-desc', descripcion);
                
                if (limite === 0) {
                    item.classList.add('blocked');
                }
                
                var limitClass = '';
                if (uso >= limite) {
                    limitClass = 'exceeded';
                } else if (uso >= limite * 0.8) {
                    limitClass = 'warning';
                }
                
                item.innerHTML = '<span class="activity-code">' + codigo + '</span><span class="activity-desc">' + descripcion + '</span><span class="activity-limit ' + limitClass + '">' + uso + '/' + limite + ' horas</span>';
                
                if (limite > 0) {
                    // Desktop drag events
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                    
                    // Touch events para m√≥viles
                    item.addEventListener('touchstart', handleTouchStart, { passive: false });
                    item.addEventListener('touchmove', handleTouchMove, { passive: false });
                    item.addEventListener('touchend', handleTouchEnd, { passive: false });
                }
                
                grid.appendChild(item);
            }
            
            actualizarContadoresActividades();
        }

        function contarActividadesEnHorario() {
            for (var codigo in usoPorActividad) {
                usoPorActividad[codigo] = 0;
            }
            
            document.querySelectorAll('td[data-actividad]').forEach(function(celda) {
                var codigo = celda.getAttribute('data-actividad');
                var horas = parseInt(celda.getAttribute('data-horas') || '1');
                if (codigo) {
                    usoPorActividad[codigo] = (usoPorActividad[codigo] || 0) + horas;
                }
            });
        }

        function handleDragStart(e) {
            var codigo = e.target.getAttribute('data-code');
            var limite = limitesActividades[codigo] || 0;
            var uso = usoPorActividad[codigo] || 0;
            
            if (uso >= limite) {
                e.preventDefault();
                showToast('Ya usaste todas las ' + limite + ' horas de ' + codigo, 'warning');
                return;
            }
            
            draggedElement = e.target;
            draggedTipo = e.target.getAttribute('data-tipo');
            draggedSource = 'barra';
            draggedDesc = e.target.getAttribute('data-desc');
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('code', codigo);
            e.dataTransfer.setData('tipo', draggedTipo);
            e.dataTransfer.setData('source', 'barra');
            e.dataTransfer.setData('desc', draggedDesc);
        }

        function handleDragEnd() {
            draggedElement = null;
            draggedTipo = null;
            draggedSource = null;
            draggedDesc = null;
        }

        var menuBtn = document.getElementById('menuBtn');
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('overlay');

        menuBtn.addEventListener('click', function(e) {
            e.preventDefault();
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.getElementById('userDropdown').classList.remove('active');
            document.getElementById('userArrow').classList.remove('rotated');
        });

        var userInfo = document.getElementById('userInfo');
        var userDropdown = document.getElementById('userDropdown');
        var userArrow = document.getElementById('userArrow');

        userInfo.addEventListener('click', function() {
            userDropdown.classList.toggle('active');
            userArrow.classList.toggle('rotated');
        });

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('td[data-activity-code]').forEach(function(celda) {
                var code = celda.getAttribute('data-activity-code');
                var descElement = celda.querySelector('.activity-description');
                if (descElement && actividadesDisponibles[code]) {
                    descElement.textContent = actividadesDisponibles[code];
                }
            });
            
            document.querySelectorAll('td[data-actividad]').forEach(function(celda) {
                var codigo = celda.getAttribute('data-actividad');
                
                celda.setAttribute('draggable', 'true');
                celda.style.cursor = 'move';
                
                celda.addEventListener('dragstart', function(e) {
                    draggedElement = e.currentTarget;
                    draggedTipo = 'normal';
                    draggedSource = 'celda';
                    draggedDesc = actividadesDisponibles[codigo] || '';
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('code', codigo);
                    e.dataTransfer.setData('tipo', draggedTipo);
                    e.dataTransfer.setData('source', 'celda');
                    e.dataTransfer.setData('desc', draggedDesc);
                    e.currentTarget.style.opacity = '0.5';
                });
                
                celda.addEventListener('dragend', function(e) {
                    e.currentTarget.style.opacity = '1';
                });
            });
            
            // Inicializar listeners en celdas drop-target
            document.querySelectorAll('.drop-target').forEach(function(target) {
                agregarListeners(target);
            });
            
            // Botones de navegaci√≥n para actividades
            var activitiesContainer = document.getElementById('activitiesGrid');
            var btnScrollLeft = document.getElementById('btnScrollLeft');
            var btnScrollRight = document.getElementById('btnScrollRight');
            
            if (btnScrollLeft && btnScrollRight && activitiesContainer) {
                btnScrollLeft.addEventListener('click', function() {
                    activitiesContainer.scrollBy({
                        left: -200,
                        behavior: 'smooth'
                    });
                });
                
                btnScrollRight.addEventListener('click', function() {
                    activitiesContainer.scrollBy({
                        left: 200,
                        behavior: 'smooth'
                    });
                });
            }
            
            inicializarActividades();
            inicializarHorasPorDia();
        });

        function handleDragOver(e) {
            e.preventDefault();
            var target = e.currentTarget;
            
            // Obtener c√≥digo desde el elemento arrastrado (m√°s confiable que dataTransfer en dragover)
            var code = '';
            if (draggedElement) {
                code = draggedElement.getAttribute('data-code') || draggedElement.getAttribute('data-actividad');
            }
            
            // Si no hay c√≥digo, intentar desde dataTransfer (fallback)
            if (!code) {
                code = e.dataTransfer.getData('code');
            }
            
            var periodoId = target.getAttribute('data-periodo');
            
            // Solo validar si tenemos un c√≥digo v√°lido
            if (code) {
                // √öNICA VALIDACI√ìN: Bloquear si T/AES en per√≠odo no v√°lido
                if (code === 'T/AES' && !esPeriodoValidoParaTAES(periodoId)) {
                    target.classList.add('drop-zone-blocked');
                    e.dataTransfer.dropEffect = 'none';
                    return;
                }
                
                // ELIMINADO: Ya no bloqueamos otras actividades en per√≠odos T/AES
            }
            
            e.dataTransfer.dropEffect = draggedSource === 'barra' ? 'copy' : 'move';
            target.classList.add('drop-zone');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drop-zone', 'drop-zone-blocked');
        }

        function handleDrop(e) {
            e.preventDefault();
            var target = e.currentTarget;
            target.classList.remove('drop-zone', 'drop-zone-blocked');
            
            var code = e.dataTransfer.getData('code');
            var tipo = e.dataTransfer.getData('tipo');
            var source = e.dataTransfer.getData('source');
            var desc = e.dataTransfer.getData('desc') || actividadesDisponibles[code] || '';
            
            handleDropOnTarget(target, code, tipo, desc, source);
        }

        function handleDropOnTarget(target, code, tipo, desc, source) {
            console.log('=== DROP INICIADO ===');
            console.log('Code:', code);
            console.log('Target:', target);
            console.log('Source:', source);
            
            if (!code) {
                console.log('ERROR: No hay c√≥digo');
                showToast('Error: No se pudo identificar la actividad', 'error');
                return;
            }
            
            if (target.hasAttribute('data-actividad')) {
                console.log('ERROR: Celda ya tiene actividad');
                if (source === 'celda' && draggedElement) {
                    draggedElement.style.opacity = '1';
                }
                showToast('Esta casilla ya tiene una actividad', 'warning');
                return;
            }
            
            var periodoId = target.getAttribute('data-periodo');
            console.log('Periodo ID:', periodoId);
            
            // √öNICA VALIDACI√ìN: T/AES solo puede ir en per√≠odos 6, 7, 9, 10
            if (code === 'T/AES' && !esPeriodoValidoParaTAES(periodoId)) {
                console.log('ERROR: T/AES en per√≠odo inv√°lido');
                if (source === 'celda' && draggedElement) {
                    draggedElement.style.opacity = '1';
                }
                showToast('T/AES solo puede colocarse en per√≠odos 6, 7, 9 y 10 (üïê)', 'error');
                return;
            }
            
            var diaIdReal = obtenerDiaIdDesdeFila(target);
            var horasActuales = horasPorDia[diaIdReal] || 0;
            console.log('D√≠a:', diaIdReal, 'Horas actuales:', horasActuales);
            
            if (source === 'barra' && horasActuales >= HORAS_MAXIMAS_POR_DIA) {
                console.log('ERROR: L√≠mite de horas alcanzado');
                var fila = target.closest('tr');
                var diaNombre = fila.querySelector('th').textContent.trim();
                showToast(diaNombre + ': L√≠mite de ' + HORAS_MAXIMAS_POR_DIA + 'h alcanzado', 'error');
                return;
            }
            
            if (source === 'barra') {
                var limite = limitesActividades[code] || 0;
                var uso = usoPorActividad[code] || 0;
                console.log('L√≠mite:', limite, 'Uso:', uso);
                
                if (uso >= limite) {
                    console.log('ERROR: L√≠mite de actividad alcanzado');
                    showToast('L√≠mite alcanzado para ' + code + ': ' + limite + ' horas', 'error');
                    return;
                }
            }

            console.log('‚úì Validaciones pasadas - Colocando actividad');
            
            if (source === 'celda' && draggedElement) {
                limpiarCelda(draggedElement, true);
            }

            colocarActividad(target, code, tipo, desc, source === 'celda');
        }

        function limpiarCelda(celda, esMovimiento) {
            var codigo = celda.getAttribute('data-actividad');
            var horas = parseInt(celda.getAttribute('data-horas') || '1');
            
            if (codigo && !esMovimiento) {
                usoPorActividad[codigo] = Math.max(0, (usoPorActividad[codigo] || 0) - horas);
            }
            
            var dia = celda.getAttribute('data-dia');
            var periodo = celda.getAttribute('data-periodo');
            var colspan = parseInt(celda.getAttribute('colspan') || '1');
            
            var permiteTaes = celda.getAttribute('data-permite-taes') === 'true';
            
            celda.classList.remove('has-activity', 'color-complementaria');
            celda.classList.add('drop-target');
            if (permiteTaes) {
                celda.classList.add('taes-allowed');
            }
            celda.removeAttribute('data-actividad');
            celda.removeAttribute('data-activity-code');
            celda.removeAttribute('data-horas');
            celda.removeAttribute('draggable');
            celda.style.cursor = '';
            celda.innerHTML = '';
            celda.setAttribute('colspan', '1');
            
            if (colspan > 1) {
                var tr = celda.parentElement;
                var celdaIndex = Array.from(tr.children).indexOf(celda);
                
                for (var i = 1; i < colspan; i++) {
                    var periodoSig = (parseInt(periodo) + i).toString();
                    var nuevaCelda = document.createElement('td');
                    nuevaCelda.className = 'drop-target';
                    
                    if (esPeriodoValidoParaTAES(periodoSig)) {
                        nuevaCelda.classList.add('taes-allowed');
                        nuevaCelda.setAttribute('data-permite-taes', 'true');
                    } else {
                        nuevaCelda.setAttribute('data-permite-taes', 'false');
                    }
                    
                    nuevaCelda.setAttribute('data-dia', dia);
                    nuevaCelda.setAttribute('data-periodo', periodoSig);
                    
                    agregarListeners(nuevaCelda);
                    
                    if (celdaIndex + i < tr.children.length) {
                        tr.insertBefore(nuevaCelda, tr.children[celdaIndex + i]);
                    } else {
                        tr.appendChild(nuevaCelda);
                    }
                }
            }
            
            agregarListeners(celda);
            
            if (!esMovimiento) {
                actualizarContadoresActividades();
                calcularHorasPorDia();
                recalcularYGuardar();
            }
        }

        function colocarActividad(celda, code, tipo, desc, esMovimiento) {
            var dia = celda.getAttribute('data-dia');
            var periodo = parseInt(celda.getAttribute('data-periodo'));
            var diaIdReal = obtenerDiaIdDesdeFila(celda);
            var tr = celda.parentElement;
            
            var todasLasCeldas = Array.from(tr.querySelectorAll('td'));
            
            var celdaAnterior = null;
            var periodoAnteriorFin = periodo - 1;
            
            for (var i = 0; i < todasLasCeldas.length; i++) {
                var c = todasLasCeldas[i];
                if (c.getAttribute('data-actividad') === code) {
                    var pInicio = parseInt(c.getAttribute('data-periodo'));
                    var horas = parseInt(c.getAttribute('data-horas') || '1');
                    var pFin = pInicio + horas - 1;
                    
                    if (pFin === periodoAnteriorFin) {
                        celdaAnterior = c;
                        break;
                    }
                }
            }
            
            var celdaSiguiente = null;
            var periodoSiguienteInicio = periodo + 1;
            
            for (var i = 0; i < todasLasCeldas.length; i++) {
                var c = todasLasCeldas[i];
                if (c.getAttribute('data-actividad') === code) {
                    var pInicio = parseInt(c.getAttribute('data-periodo'));
                    
                    if (pInicio === periodoSiguienteInicio) {
                        celdaSiguiente = c;
                        break;
                    }
                }
            }
            
            if (celdaAnterior) {
                var horasAnterior = parseInt(celdaAnterior.getAttribute('data-horas') || '1');
                var nuevasHoras = horasAnterior + 1;
                
                if (celdaSiguiente) {
                    var horasSiguiente = parseInt(celdaSiguiente.getAttribute('data-horas') || '1');
                    nuevasHoras += horasSiguiente;
                    celdaSiguiente.remove();
                }
                
                celda.remove();
                
                celdaAnterior.setAttribute('colspan', nuevasHoras.toString());
                celdaAnterior.setAttribute('data-horas', nuevasHoras.toString());
                
                var hoursSpan = celdaAnterior.querySelector('.activity-hours');
                if (nuevasHoras > 1) {
                    if (hoursSpan) {
                        hoursSpan.textContent = nuevasHoras + ' horas';
                    } else {
                        var span = document.createElement('span');
                        span.className = 'activity-hours';
                        span.textContent = nuevasHoras + ' horas';
                        celdaAnterior.appendChild(span);
                    }
                }
                
                if (!esMovimiento) {
                    usoPorActividad[code] = (usoPorActividad[code] || 0) + 1;
                    horasPorDia[diaIdReal] = (horasPorDia[diaIdReal] || 0) + 1;
                }
                
                actualizarContadoresActividades();
                actualizarIndicadorHoras();
                recalcularYGuardar();
                
                var fila = tr;
                var diaNombre = fila ? fila.querySelector('th').textContent.trim() : '';
                showToast(code + ' fusionado en ' + diaNombre + ': ' + nuevasHoras + ' horas', 'success', 2000);
                
                return;
            }
            
            if (celdaSiguiente) {
                var horasSiguiente = parseInt(celdaSiguiente.getAttribute('data-horas') || '1');
                var nuevasHoras = 1 + horasSiguiente;
                
                celda.classList.remove('drop-target', 'taes-allowed');
                celda.classList.add('has-activity', 'color-complementaria');
                celda.setAttribute('data-actividad', code);
                celda.setAttribute('data-activity-code', code);
                celda.setAttribute('data-horas', nuevasHoras.toString());
                celda.setAttribute('colspan', nuevasHoras.toString());
                celda.setAttribute('draggable', 'true');
                celda.style.cursor = 'move';
                
                celda.addEventListener('dragstart', function(e) {
                    draggedElement = e.currentTarget;
                    draggedTipo = 'normal';
                    draggedSource = 'celda';
                    draggedDesc = desc || actividadesDisponibles[code] || '';
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('code', code);
                    e.dataTransfer.setData('tipo', draggedTipo);
                    e.dataTransfer.setData('source', 'celda');
                    e.dataTransfer.setData('desc', draggedDesc);
                    e.currentTarget.style.opacity = '0.5';
                });
                
                celda.addEventListener('dragend', function(e) {
                    e.currentTarget.style.opacity = '1';
                });
                
                var hoursHtml = nuevasHoras > 1 ? '<span class="activity-hours">' + nuevasHoras + ' horas</span>' : '';
                
                celda.innerHTML = '<button class="remove-btn" onclick="removeActivity(this)">√ó</button><span class="lesson-subject">' + code + '</span><span class="activity-description">' + desc + '</span>' + hoursHtml;
                
                celdaSiguiente.remove();
                
                if (!esMovimiento) {
                    usoPorActividad[code] = (usoPorActividad[code] || 0) + 1;
                    horasPorDia[diaIdReal] = (horasPorDia[diaIdReal] || 0) + 1;
                }
                
                actualizarContadoresActividades();
                actualizarIndicadorHoras();
                recalcularYGuardar();
                
                var fila = tr;
                var diaNombre = fila ? fila.querySelector('th').textContent.trim() : '';
                showToast(code + ' fusionado en ' + diaNombre + ': ' + nuevasHoras + ' horas', 'success', 2000);
                
                return;
            }
            
            celda.classList.remove('drop-target', 'taes-allowed');
            celda.classList.add('has-activity', 'color-complementaria');
            celda.setAttribute('data-actividad', code);
            celda.setAttribute('data-activity-code', code);
            celda.setAttribute('data-horas', '1');
            celda.setAttribute('colspan', '1');
            celda.setAttribute('draggable', 'true');
            celda.style.cursor = 'move';
            
            celda.addEventListener('dragstart', function(e) {
                draggedElement = e.currentTarget;
                draggedTipo = 'normal';
                draggedSource = 'celda';
                draggedDesc = desc || actividadesDisponibles[code] || '';
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('code', code);
                e.dataTransfer.setData('tipo', draggedTipo);
                e.dataTransfer.setData('source', 'celda');
                e.dataTransfer.setData('desc', draggedDesc);
                e.currentTarget.style.opacity = '0.5';
            });
            
            celda.addEventListener('dragend', function(e) {
                e.currentTarget.style.opacity = '1';
            });
            
            celda.innerHTML = '<button class="remove-btn" onclick="removeActivity(this)">√ó</button><span class="lesson-subject">' + code + '</span><span class="activity-description">' + desc + '</span>';
            
            if (!esMovimiento) {
                usoPorActividad[code] = (usoPorActividad[code] || 0) + 1;
                horasPorDia[diaIdReal] = (horasPorDia[diaIdReal] || 0) + 1;
            }
            
            actualizarContadoresActividades();
            actualizarIndicadorHoras();
            recalcularYGuardar();
            
            var fila = tr;
            var diaNombre = fila ? fila.querySelector('th').textContent.trim() : '';
            showToast(code + ' agregado a ' + diaNombre, 'success', 1500);
        }

        function agregarListeners(target) {
            target.addEventListener('dragover', handleDragOver);
            target.addEventListener('dragleave', handleDragLeave);
            target.addEventListener('drop', handleDrop);
        }

        function removeActivity(button) {
            var celda = button.parentElement;
            var horas = parseInt(celda.getAttribute('data-horas') || '1');
            var codigo = celda.getAttribute('data-actividad');
            
            if (horas > 1) {
                var nuevasHoras = horas - 1;
                celda.setAttribute('data-horas', nuevasHoras.toString());
                celda.setAttribute('colspan', nuevasHoras.toString());
                
                usoPorActividad[codigo] = Math.max(0, (usoPorActividad[codigo] || 0) - 1);
                
                var hoursSpan = celda.querySelector('.activity-hours');
                if (nuevasHoras > 1) {
                    if (hoursSpan) {
                        hoursSpan.textContent = nuevasHoras + ' horas';
                    }
                } else {
                    if (hoursSpan) {
                        hoursSpan.remove();
                    }
                }
                
                var dia = celda.getAttribute('data-dia');
                var periodo = celda.getAttribute('data-periodo');
                var tr = celda.parentElement;
                
                var nuevoPeriodo = (parseInt(periodo) + nuevasHoras).toString();
                var nuevaCelda = document.createElement('td');
                nuevaCelda.className = 'drop-target';
                
                if (esPeriodoValidoParaTAES(nuevoPeriodo)) {
                    nuevaCelda.classList.add('taes-allowed');
                    nuevaCelda.setAttribute('data-permite-taes', 'true');
                } else {
                    nuevaCelda.setAttribute('data-permite-taes', 'false');
                }
                
                nuevaCelda.setAttribute('data-dia', dia);
                nuevaCelda.setAttribute('data-periodo', nuevoPeriodo);
                
                agregarListeners(nuevaCelda);
                
                var celdaIndex = Array.from(tr.children).indexOf(celda);
                if (celdaIndex + 1 < tr.children.length) {
                    tr.insertBefore(nuevaCelda, tr.children[celdaIndex + 1]);
                } else {
                    tr.appendChild(nuevaCelda);
                }
                
                actualizarContadoresActividades();
                calcularHorasPorDia();
                recalcularYGuardar();
                
                showToast(codigo + ': ' + nuevasHoras + ' hora' + (nuevasHoras > 1 ? 's' : '') + ' restante' + (nuevasHoras > 1 ? 's' : ''), 'info', 2000);
            } else {
                limpiarCelda(celda, false);
                showToast(codigo + ' eliminado', 'info', 1500);
            }
        }

        function actualizarContadoresActividades() {
            contarActividadesEnHorario();
            
            var grid = document.getElementById('activitiesGrid');
            grid.innerHTML = '';
            
            for (var codigo in actividadesDisponibles) {
                var descripcion = actividadesDisponibles[codigo];
                var limite = limitesActividades[codigo] || 0;
                var uso = usoPorActividad[codigo] || 0;
                
                var item = document.createElement('div');
                item.className = 'activity-item';
                item.setAttribute('draggable', limite > 0 && uso < limite ? 'true' : 'false');
                item.setAttribute('data-code', codigo);
                item.setAttribute('data-tipo', 'normal');
                item.setAttribute('data-desc', descripcion);
                
                if (limite === 0) {
                    item.classList.add('blocked');
                }
                
                var limitClass = '';
                if (uso >= limite) {
                    limitClass = 'exceeded';
                    item.classList.add('blocked');
                } else if (uso >= limite * 0.8) {
                    limitClass = 'warning';
                }
                
                item.innerHTML = '<span class="activity-code">' + codigo + '</span><span class="activity-desc">' + descripcion + '</span><span class="activity-limit ' + limitClass + '">' + uso + '/' + limite + ' horas</span>';
                
                if (limite > 0 && uso < limite) {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                    
                    item.addEventListener('touchstart', handleTouchStart, { passive: false });
                    item.addEventListener('touchmove', handleTouchMove, { passive: false });
                    item.addEventListener('touchend', handleTouchEnd, { passive: false });
                }
                
                grid.appendChild(item);
            }
        }

        function recalcularYGuardar() {
            guardarHorarioLocal();
        }

        function guardarHorarioLocal() {
            var actividades = [];
            
            document.querySelectorAll('td[data-actividad]').forEach(function(celda) {
                var actividad = celda.getAttribute('data-actividad');
                var dia = celda.getAttribute('data-dia');
                var periodoBase = celda.getAttribute('data-periodo');
                var horas = parseInt(celda.getAttribute('data-horas') || '1');
                
                for (var i = 0; i < horas; i++) {
                    var periodo = (parseInt(periodoBase) + i).toString();
                    actividades.push({
                        dia_id: dia,
                        periodo_id: periodo,
                        codigo: actividad,
                        es_taes: actividad === 'T/AES'
                    });
                }
            });

            fetch('/guardar_actividades/' + horarioId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ actividades: actividades })
            })
            .then(function(response) {
                if (response.ok) {
                    console.log('Horario guardado autom√°ticamente');
                } else {
                    return response.json().then(function(data) {
                        if (data.error) {
                            showToast(data.error, 'error');
                        }
                    });
                }
            })
            .catch(function(error) {
                console.error('Error al guardar actividades:', error);
                showToast('Error al guardar cambios', 'error');
            });
        }

        function enviarRevision() {
            document.getElementById('confirmModal').classList.add('active');
        }

        function cerrarModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        function resaltarCelda(diaId, periodoId) {
            document.querySelectorAll('.celda-resaltada').forEach(function(celda) {
                celda.classList.remove('celda-resaltada');
            });
            
            var celda = document.querySelector('td[data-dia="' + diaId + '"][data-periodo="' + periodoId + '"]');
            if (celda) {
                celda.classList.add('celda-resaltada');
                celda.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                setTimeout(function() {
                    celda.classList.remove('celda-resaltada');
                }, 3000);
            }
        }

        function confirmarEnvio() {
            cerrarModal();
            showToast('Enviando horario...', 'info', 2000);
            
            fetch('/enviar_revision/' + horarioId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    return { response: response, data: data };
                });
            })
            .then(function(result) {
                if (result.response.ok) {
                    showToast('‚úì Horario enviado exitosamente', 'success', 2000);
                    setTimeout(function() {
                        window.location.href = '/bandeja';
                    }, 2000);
                } else {
                    if (result.data.errores && result.data.errores.length > 0) {
                        result.data.errores.forEach(function(error, index) {
                            setTimeout(function() {
                                showToast(error, 'error', 5000);
                            }, index * 300);
                        });
                    } else {
                        showToast(result.data.error || 'Error al enviar horario', 'error', 4000);
                    }
                }
            })
            .catch(function(error) {
                showToast('Error de conexi√≥n. Intenta nuevamente', 'error');
            });
        }
    </script>
</body>
</html>